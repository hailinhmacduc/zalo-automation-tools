<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quét nhóm Zalo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --primary:#0084ff; --primary-dark:#0071e3; }
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#e8f1ff 0%,#f7fbff 100%);
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" stroke="%23666" viewBox="0 0 24 24" fill="none"%3E%3Cpath d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/%3E%3C/svg%3E');
      background-repeat:no-repeat;
      background-position:right .7rem center;
      background-size:1rem;
    }
    .login-bg {
      background: linear-gradient(135deg, #0084ff 0%, #0066cc 50%, #004499 100%);
    }
    .zalo-logo {
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(0, 132, 255, 0.3);
    }
    .feature-card {
      transition: all 0.3s ease;
    }
    .feature-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 132, 255, 0.15);
    }
    @media (max-width: 640px) {
      .main-container { padding: 1rem 0.75rem; max-height: none; }
      .card { margin: 0; border-radius: 1rem; padding: 1.5rem; max-width: 100%; }
      textarea { resize: vertical; min-height: 100px; }
      #groupList, #groupList2 { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 0.5rem; }
      #groupList::-webkit-scrollbar, #groupList2::-webkit-scrollbar { width: 4px; }
      #groupList::-webkit-scrollbar-track, #groupList2::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 2px; }
      #groupList::-webkit-scrollbar-thumb, #groupList2::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 2px; }
      #groupList::-webkit-scrollbar-thumb:hover, #groupList2::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    }
    .shake { animation: shake 0.5s ease-in-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body class="min-h-screen relative">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-bg min-h-screen flex items-center justify-center py-4 px-4">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 space-y-8">
      <div class="text-center space-y-4">
        <div class="flex justify-center">
          <div class="zalo-logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path d="M16 2C8.268 2 2 8.268 2 16s6.268 14 14 14 14-6.268 14-14S23.732 2 16 2zm0 25.2c-6.174 0-11.2-5.026-11.2-11.2S9.826 4.8 16 4.8 27.2 9.826 27.2 16 22.174 27.2 16 27.2z" fill="#0084ff"/>
              <path d="M22.4 14.933c0-.746-.746-1.493-1.493-1.493h-2.24V11.2c0-.746-.746-1.493-1.493-1.493s-1.493.747-1.493 1.493v2.24h-2.24c-.746 0-1.493.747-1.493 1.493s.747 1.493 1.493 1.493h2.24v2.24c0 .746.746 1.493 1.493 1.493s1.493-.747 1.493-1.493v-2.24h2.24c.747 0 1.493-.747 1.493-1.493z" fill="#0084ff"/>
            </svg>
          </div>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Đăng nhập hệ thống</h1>
          <p class="text-sm text-gray-600 mt-1">Quét nhóm Zalo tự động</p>
        </div>
      </div>
      <form id="loginForm" class="space-y-6">
        <div class="space-y-4">
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Tên đăng nhập</label>
            <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Nhập tên đăng nhập" required />
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu</label>
            <div class="relative">
              <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12" placeholder="Nhập mật khẩu" required />
              <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                <svg id="eyeOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <svg id="eyeClosed" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div id="loginError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
          <p class="text-sm text-red-600 text-center">Tên đăng nhập hoặc mật khẩu không đúng!</p>
        </div>
        <button type="submit" id="loginBtn" class="w-full bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-3 rounded-lg transition-all disabled:opacity-60 touch-manipulation">
          <span id="loginBtnText">Đăng nhập</span>
          <svg id="loginSpinner" class="hidden animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
          </svg>
        </button>
      </form>
      <div class="text-center pt-4 border-t border-gray-100">
        <p class="text-xs text-gray-400">Developed by Hailinhmacduc</p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden">
    <!-- Header -->
    <div class="fixed top-4 right-4 z-40 flex gap-2">
      <button id="homeBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
        </svg>
        Trang chủ
      </button>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
        Đăng xuất
      </button>
    </div>

<div class="main-container min-h-screen flex items-center justify-center py-4 px-4 sm:py-10">

      <!-- Overlay loader + message -->
      <div id="overlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50 text-center px-6">
        <svg id="overlaySpinner" class="animate-spin h-10 w-10 text-[var(--primary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p id="overlayText" class="mt-3 text-sm text-gray-700">Đang xử lý...</p>
      </div>

      <!-- TRANG CHỦ - CHỌN TÍNH NĂNG -->
      <div id="homePage" class="card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-8">
        <header class="text-center space-y-2">
          <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-wide uppercase">Hệ thống quét nhóm Zalo</h1>
          <p class="text-sm text-gray-500">Quét &amp; gửi tin nhắn cho thành viên nhóm Zalo nhanh chóng</p>
          <p class="text-xs text-amber-600 font-medium">***Lưu ý: mỗi 1 nick 1 ngày gửi tối đa 40 người</p>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6">
          <!-- Tính năng 1: Gửi tin nhắn cho thành viên -->
          <div id="feature1Card" class="feature-card bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-6 cursor-pointer text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-blue-500 rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-blue-900">Gửi tin nhắn</h3>
              <p class="text-sm text-blue-700">Gửi tin nhắn cho thành viên trong nhóm</p>
            </div>
          </div>

          <!-- Tính năng 2: Đăng bài tự động -->
          <div id="feature2Card" class="feature-card bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-2xl p-6 cursor-pointer text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-green-500 rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-green-900">Đăng bài tự động</h3>
              <p class="text-sm text-green-700">Đăng bài cho tất cả các nhóm được chọn</p>
            </div>
          </div>

          <!-- Tính năng 3: Mời thành viên -->
          <div id="feature3Card" class="feature-card bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-2xl p-6 cursor-pointer text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-purple-500 rounded-2xl flex items-center justify-center">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-purple-900">Mời thành viên</h3>
              <p class="text-sm text-purple-700">Mời thành viên vào nhóm</p>
            </div>
          </div>
        </div>

        <!-- Tác giả -->
        <div class="text-center pt-4 border-t border-gray-100">
          <p class="text-xs text-gray-400">Developed by Hailinhmacduc</p>
        </div>
      </div>

      <!-- TÍNH NĂNG 1: GỬI TIN NHẮN CHO THÀNH VIÊN -->
      <div id="feature1Page" class="hidden">
        <!-- STEP 1 -->
        <div id="step1" class="card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Gửi tin nhắn cho thành viên</h1>
            <p class="text-sm text-gray-500">Quét nhóm và gửi tin nhắn cho thành viên</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect" class="text-sm font-medium text-gray-600">Chọn tài khoản (nick) cần quét nhóm</label>
            <div class="relative">
              <select id="nickSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary">
                <option value="" disabled selected hidden>Chọn một nick …</option>
                <option value="test">test</option>
                <option value="Dương Nguyễn">Dương Nguyễn</option>
                <option value="Đức Phòng">Đức Phòng</option>
              </select>
            </div>
          </div>

          <button id="scanBtn" class="w-full flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-3 rounded-lg transition disabled:opacity-60 touch-manipulation">
            <span>Quét nhóm</span>
            <svg id="spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection" class="hidden space-y-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800 mb-2">Kết quả</h2>
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <ul id="groupList" class="list-decimal list-inside space-y-1 text-gray-700 text-sm"></ul>
                <p id="emptyMsg" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
              </div>
            </div>
            <div id="actionsBox" class="hidden space-y-3 pt-2 border-t border-gray-200">
              <label for="groupSelect" class="block text-sm font-medium text-gray-600">Chọn nhóm để gửi tin nhắn</label>
              <select id="groupSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary"></select>
              <button id="nextBtn" class="w-full flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Tiếp tục</button>
            </div>
          </section>
        </div>
<!-- STEP 2 -->
        <div id="step2" class="hidden card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Gửi tin nhắn tới nhóm</h2>
            <p id="chosenGroup" class="text-sm text-gray-600 break-words"></p>
          </header>

          <div class="space-y-4">
            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Nội dung cần gửi <span class="text-red-500">*</span></label>
              <textarea id="message" rows="4" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary resize-vertical" placeholder="Nhập nội dung tin nhắn..."></textarea>
            </div>

            <div>
              <label for="images" class="block text-sm font-medium text-gray-700 mb-1">Tải ảnh lên (tối đa 3 ảnh)</label>
              <input id="images" type="file" accept="image/*" multiple class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" />
              
              <div id="imageStatus" class="mt-2 text-sm hidden">
                <div id="imageCountSuccess" class="hidden text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageCountText"></span>
                </div>
                <div id="imageCountWarning" class="hidden text-amber-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageWarningText"></span>
                </div>
                <div id="imageCountError" class="hidden text-red-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="imageErrorText"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="backBtn" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay lại</button>
            <button id="sendMsgBtn" class="flex-1 flex items-center justify-center gap-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">
              <span>Gửi tin nhắn</span>
              <svg id="spinnerSend" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- TÍNH NĂNG 2: ĐĂNG BÀI TỰ ĐỘNG -->
      <div id="feature2Page" class="hidden">
        <!-- STEP 1: QUÉT NHÓM -->
        <div id="step2_1" class="card w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Đăng bài tự động</h1>
            <p class="text-sm text-gray-500">Quét nhóm và chọn nhóm để đăng bài</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect2" class="text-sm font-medium text-gray-600">Chọn tài khoản (nick) cần quét nhóm</label>
            <div class="relative">
              <select id="nickSelect2" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-primary">
                <option value="" disabled selected hidden>Chọn một nick …</option>
                <option value="test">test</option>
                <option value="Dương Nguyễn">Dương Nguyễn</option>
                <option value="Đức Phòng">Đức Phòng</option>
              </select>
            </div>
          </div>

          <button id="scanBtn2" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition disabled:opacity-60 touch-manipulation">
            <span>Quét nhóm</span>
            <svg id="spinner2" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection2" class="hidden space-y-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800 mb-2">Kết quả quét nhóm</h2>
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <div id="groupListContainer2" class="space-y-3">
                  <div class="flex items-center gap-2 p-2 bg-green-50 rounded-lg border border-green-200">
                    <input type="checkbox" id="selectAllGroups" class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="selectAllGroups" class="text-sm font-medium text-green-800">Chọn tất cả nhóm</label>
                  </div>
                  
                  <div id="groupList2" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
                <p id="emptyMsg2" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
              </div>
            </div>
            <div id="actionsBox2" class="hidden space-y-3 pt-2 border-t border-gray-200">
              <div id="selectedGroupsInfo" class="text-sm text-gray-600">
                <span id="selectedCount">0</span> nhóm được chọn
              </div>
              <button id="nextBtn2" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Tiếp tục</button>
            </div>
          </section>
        </div>
<!-- STEP 2: SOẠN NỘI DUNG -->
        <div id="step2_2" class="hidden card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Soạn nội dung đăng bài</h2>
            <p id="selectedGroupsDisplay" class="text-sm text-gray-600 break-words"></p>
          </header>

          <div class="space-y-6">
            <div>
              <label for="postContent" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                  </svg>
                  Nội dung bài viết
                  <span class="text-red-500">*</span>
                </span>
              </label>
              <textarea 
                id="postContent" 
                rows="6" 
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 resize-vertical" 
                placeholder="Bạn đang nghĩ gì...?"
                required
              ></textarea>
              <div class="mt-1 text-xs text-gray-500">
                <span id="charCount">0</span> ký tự
              </div>
            </div>

            <div>
              <label for="postImages" class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                  </svg>
                  Tải ảnh lên
                  <span class="text-red-500">* (Bắt buộc 4 ảnh)</span>
                </span>
              </label>
              <input 
                id="postImages" 
                type="file" 
                accept="image/*" 
                multiple 
                class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 file:mr-3 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200" 
                required
              />
              
              <div id="postImageStatus" class="mt-2 text-sm hidden">
                <div id="postImageSuccess" class="hidden text-green-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageSuccessText"></span>
                </div>
                <div id="postImageWarning" class="hidden text-amber-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageWarningText"></span>
                </div>
                <div id="postImageError" class="hidden text-red-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="postImageErrorText"></span>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  Hẹn giờ đăng bài (tùy chọn)
                </span>
              </label>
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableSchedule" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                <label for="enableSchedule" class="text-sm text-gray-600">Bật hẹn giờ đăng bài</label>
              </div>
              
              <div id="scheduleInputs" class="hidden mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="scheduleDate" class="block text-xs font-medium text-gray-600 mb-1">Ngày</label>
                  <input 
                    type="date" 
                    id="scheduleDate" 
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500"
                  />
                </div>
                <div>
                  <label for="scheduleTime" class="block text-xs font-medium text-gray-600 mb-1">Giờ</label>
                  <input 
                    type="time" 
                    id="scheduleTime" 
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="backBtn2" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay lại</button>
            <button id="publishBtn" class="flex-1 flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">
              <span>Đăng bài</span>
              <svg id="publishSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- TÍNH NĂNG 3: MỜI THÀNH VIÊN -->
      <div id="feature3Page" class="hidden">
        <!-- STEP 1: QUÉT NHÓM -->
        <div id="step3_1" class="card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Mời thành viên vào nhóm</h1>
            <p class="text-sm text-gray-500">Quét nhóm và chọn thành viên để mời vào nhóm khác</p>
          </header>

          <div class="space-y-2">
            <label for="nickSelect3" class="text-sm font-medium text-gray-600">Chọn tài khoản (nick) cần quét nhóm</label>
            <div class="relative">
              <select id="nickSelect3" class="w-full border border-gray-300 rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-purple-500">
                <option value="test">test</option>
                <option value="Dương Nguyễn">Dương Nguyễn</option>
                <option value="Đức Phòng">Đức Phòng</option>
              </select>
            </div>
            <p class="text-xs text-amber-600 font-medium">***Lưu ý: mỗi nick 1 ngày chỉ nên mời 30 người</p>
          </div>

          <button id="scanBtn3" class="w-full flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 rounded-lg transition disabled:opacity-60 touch-manipulation">
            <span>Quét nhóm</span>
            <svg id="spinner3" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
          </button>

          <section id="resultSection3" class="hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <!-- Cột bên trái: Chọn nhóm nguồn -->
              <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-1">
                  <svg class="w-5 h-5 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                  </svg>
                  Chọn nhóm nguồn
                </h2>
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 h-80 overflow-y-auto">
                  <div id="sourceGroupList" class="space-y-2">
                    <!-- Danh sách nhóm nguồn sẽ được thêm vào đây -->
                  </div>
                  <p id="emptySourceMsg" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
                </div>
                <div class="text-sm text-gray-600">
                  <span id="selectedSourceCount">0</span> nhóm nguồn được chọn
                </div>
              </div>
              
              <!-- Cột bên phải: Chọn nhóm đích -->
              <div class="space-y-3">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-1">
                  <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                  </svg>
                  Chọn nhóm đích
                </h2>
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 h-80 overflow-y-auto">
                  <div id="targetGroupList" class="space-y-2">
                    <!-- Danh sách nhóm đích sẽ được thêm vào đây -->
                  </div>
                  <p id="emptyTargetMsg" class="text-gray-400 italic text-sm">Không tìm thấy nhóm nào</p>
                </div>
                <div class="text-sm text-gray-600">
                  <span id="selectedTargetCount">0</span> nhóm đích được chọn
                </div>
              </div>
            </div>
            <div id="actionsBox3" class="space-y-3 pt-4 border-t border-gray-200">
              <button id="nextBtn3" class="w-full flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">Tiếp tục</button>
            </div>
          </section>
        </div>

        <!-- STEP 2: QUÉT THÀNH VIÊN VÀ MỜI -->
        <div id="step3_2" class="hidden card w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 space-y-6 sm:space-y-8">
          <header class="text-center space-y-1">
            <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 tracking-wide">Quét và mời thành viên</h2>
            <div class="text-sm text-gray-600 break-words">
              <p id="sourceGroupDisplay" class="font-medium"></p>
              <p id="targetGroupDisplay" class="font-medium"></p>
            </div>
          </header>

          <div class="space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    Số lượng thành viên quét được
                  </span>
                </label>
                <div id="memberCount" class="text-xl font-semibold text-purple-600">0</div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Số lượng thành viên đã mời
                  </span>
                </label>
                <div id="invitedCount" class="text-xl font-semibold text-green-600">0</div>
              </div>
            </div>

            <div class="space-y-2">
              <label for="maxInvites" class="block text-sm font-medium text-gray-700">Số lượng thành viên cần mời (tối đa)</label>
              <input 
                type="number" 
                id="maxInvites" 
                min="1" 
                max="100" 
                value="30"
                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500"
              />
              <p class="text-xs text-gray-500">Giới hạn số lượng để tránh bị khóa tài khoản</p>
            </div>

            <div class="flex gap-2 items-center">
              <input type="checkbox" id="autoInvite" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
              <label for="autoInvite" class="text-sm text-gray-600">Tự động mời khi quét xong</label>
            </div>
          </div>

          <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-3">
              <button id="backBtn3" class="flex-1 flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 rounded-lg transition touch-manipulation">Quay lại</button>
              <button id="scanMembersBtn" class="flex-1 flex items-center justify-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation">
                <span>Quét thành viên</span>
                <svg id="scanMembersSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
              </button>
            </div>
            
            <button id="inviteBtn" class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 rounded-lg transition disabled:opacity-60 touch-manipulation" disabled>
              <span>Mời thành viên</span>
              <svg id="inviteSpinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>
            </button>
          </div>

          <div id="progressContainer" class="hidden space-y-2">
            <div class="flex justify-between text-sm text-gray-600">
              <span>Tiến trình</span>
              <span id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progressBar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <script>
const scanWebhook = 'https://primary-production-55bc0.up.railway.app/webhook/zalo-automation';
    const sendWebhook = 'https://primary-production-55bc0.up.railway.app/webhook/zalo-sent-text-image';
    const inviteWebhook = 'https://primary-production-55bc0.up.railway.app/webhook/zalo-invite-member';

    const ADMIN_USERNAME = 'Admin';
    const ADMIN_PASSWORD = 'nguyenduc139@';

    const $ = id => document.getElementById(id);
    const toggle = (el, show) => el.classList[show ? 'remove' : 'add']('hidden');

    // Elements
    const loginPage = $('loginPage');
    const mainApp = $('mainApp');
    const loginForm = $('loginForm');
    const loginError = $('loginError');
    const loginBtn = $('loginBtn');
    const loginBtnText = $('loginBtnText');
    const loginSpinner = $('loginSpinner');
    const logoutBtn = $('logoutBtn');
    const homeBtn = $('homeBtn');
    const togglePassword = $('togglePassword');
    const passwordInput = $('password');
    const eyeOpen = $('eyeOpen');
    const eyeClosed = $('eyeClosed');

    // Pages
    const homePage = $('homePage');
    const feature1Page = $('feature1Page');
    const feature2Page = $('feature2Page');
    const feature3Page = $('feature3Page');
    
    // Feature 2 elements
    const step2_1 = $('step2_1');
    const step2_2 = $('step2_2');
    const nickSelect2 = $('nickSelect2');
    const scanBtn2 = $('scanBtn2');
    const spinner2 = $('spinner2');
    const resultSection2 = $('resultSection2');
    const groupList2 = $('groupList2');
    const emptyMsg2 = $('emptyMsg2');
    const actionsBox2 = $('actionsBox2');
    const selectAllGroups = $('selectAllGroups');
    const selectedCount = $('selectedCount');
    const nextBtn2 = $('nextBtn2');
    const backBtn2 = $('backBtn2');
    const selectedGroupsDisplay = $('selectedGroupsDisplay');
    
    // Feature 3 elements
    const step3_1 = $('step3_1');
    const step3_2 = $('step3_2');
    const nickSelect3 = $('nickSelect3');
    const scanBtn3 = $('scanBtn3');
    const spinner3 = $('spinner3');
    const resultSection3 = $('resultSection3');
    const sourceGroupList = $('sourceGroupList');
    const targetGroupList = $('targetGroupList');
    const emptySourceMsg = $('emptySourceMsg');
    const emptyTargetMsg = $('emptyTargetMsg');
    const selectedSourceCount = $('selectedSourceCount');
    const selectedTargetCount = $('selectedTargetCount');
    const actionsBox3 = $('actionsBox3');
    const nextBtn3 = $('nextBtn3');
    const backBtn3 = $('backBtn3');
    const sourceGroupDisplay = $('sourceGroupDisplay');
    const targetGroupDisplay = $('targetGroupDisplay');
    const memberCount = $('memberCount');
    const invitedCount = $('invitedCount');
    const maxInvites = $('maxInvites');
    const autoInvite = $('autoInvite');
    const scanMembersBtn = $('scanMembersBtn');
    const scanMembersSpinner = $('scanMembersSpinner');
    const inviteBtn = $('inviteBtn');
    const inviteSpinner = $('inviteSpinner');
    const progressContainer = $('progressContainer');
    const progressBar = $('progressBar');
    const progressText = $('progressText');
    
    // Post content elements
    const postContent = $('postContent');
    const postImages = $('postImages');
    const enableSchedule = $('enableSchedule');
    const scheduleInputs = $('scheduleInputs');
    const scheduleDate = $('scheduleDate');
    const scheduleTime = $('scheduleTime');
    const publishBtn = $('publishBtn');
    const publishSpinner = $('publishSpinner');
    const charCount = $('charCount');
    
    // Post image status elements
    const postImageStatus = $('postImageStatus');
    const postImageSuccess = $('postImageSuccess');
    const postImageWarning = $('postImageWarning');
    const postImageError = $('postImageError');
    const postImageSuccessText = $('postImageSuccessText');
    const postImageWarningText = $('postImageWarningText');
    const postImageErrorText = $('postImageErrorText');

    // Feature cards
    const feature1Card = $('feature1Card');
    const feature2Card = $('feature2Card');
    const feature3Card = $('feature3Card');

    const overlay = $('overlay');
    const overlayText = $('overlayText');
    const step1 = $('step1');
    const step2 = $('step2');

    const nickSelect = $('nickSelect');
    const scanBtn = $('scanBtn');
    const spinner = $('spinner');
    const resultSec = $('resultSection');
    const groupList = $('groupList');
    const emptyMsg = $('emptyMsg');
    const actionsBox = $('actionsBox');
    const groupSelect = $('groupSelect');
    const nextBtn = $('nextBtn');

    const backBtn = $('backBtn');
    const sendMsgBtn = $('sendMsgBtn');
    const spinnerSend = $('spinnerSend');
    const messageTxt = $('message');
    const imagesInput = $('images');
    const chosenGroup = $('chosenGroup');
    
    // Elements cho thông báo ảnh
    const imageStatus = $('imageStatus');
    const imageCountSuccess = $('imageCountSuccess');
    const imageCountWarning = $('imageCountWarning');
    const imageCountError = $('imageCountError');
    const imageCountText = $('imageCountText');
    const imageWarningText = $('imageWarningText');
    const imageErrorText = $('imageErrorText');

    let currentGroup = { id: '', name: '' };
    let selectedGroups = [];
    let sourceGroups = [];
    let targetGroups = [];
    let members = [];

    // Hàm hiển thị trang
    function showPage(pageToShow) {
      toggle(homePage, false);
      toggle(feature1Page, false);
      toggle(feature2Page, false);
      toggle(feature3Page, false);
      toggle(pageToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Hàm hiển thị step cho feature 2
    function showFeature2Step(stepToShow) {
      toggle(step2_1, false);
      toggle(step2_2, false);
      toggle(stepToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Hàm hiển thị step cho feature 3
    function showFeature3Step(stepToShow) {
      toggle(step3_1, false);
      toggle(step3_2, false);
      toggle(stepToShow, true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Hàm kiểm tra số lượng ảnh cho tin nhắn
    function checkImageCount() {
      const fileCount = imagesInput.files.length;
      toggle(imageCountSuccess, false);
      toggle(imageCountWarning, false);
      toggle(imageCountError, false);
      
      if (fileCount === 0) {
        toggle(imageStatus, false);
        return;
      }
      
      toggle(imageStatus, true);
      
      if (fileCount === 3) {
        toggle(imageCountSuccess, true);
        imageCountText.textContent = "Đã tải đủ 3 ảnh - Hoàn hảo!";
      } else if (fileCount < 3) {
        toggle(imageCountWarning, true);
        imageWarningText.textContent = `Đã tải ${fileCount} ảnh. Hãy tải thêm ${3 - fileCount} ảnh nữa để đủ 3 ảnh.`;
      } else {
        toggle(imageCountError, true);
        imageErrorText.textContent = `Đã tải ${fileCount} ảnh. Vui lòng xóa bớt ${fileCount - 3} ảnh hoặc tải lại để đủ 3 ảnh.`;
      }
    }
    
    // Hàm kiểm tra số lượng ảnh cho đăng bài
    function checkPostImageCount() {
      const fileCount = postImages.files.length;
      toggle(postImageSuccess, false);
      toggle(postImageWarning, false);
      toggle(postImageError, false);
      
      if (fileCount === 0) {
        toggle(postImageStatus, false);
        return;
      }
      
      toggle(postImageStatus, true);
      
      if (fileCount === 4) {
        toggle(postImageSuccess, true);
        postImageSuccessText.textContent = "Đã tải đủ 4 ảnh - Hoàn hảo!";
      } else if (fileCount < 4) {
        toggle(postImageWarning, true);
        postImageWarningText.textContent = `Đã tải ${fileCount} ảnh. Cần tải thêm ${4 - fileCount} ảnh nữa để đủ 4 ảnh.`;
      } else {
        toggle(postImageError, true);
        postImageErrorText.textContent = `Đã tải ${fileCount} ảnh. Vui lòng xóa bớt ${fileCount - 4} ảnh hoặc tải lại để đủ 4 ảnh.`;
      }
    }
    
    // Hàm cập nhật số ký tự
    function updateCharCount() {
      const count = postContent.value.length;
      charCount.textContent = count;
      charCount.className = count > 1000 ? 'text-red-500' : 'text-gray-500';
    }
    
    // Hàm cập nhật số nhóm được chọn cho tính năng 2
    function updateSelectedGroupsCount() {
      const checkboxes = document.querySelectorAll('#groupList2 input[type="checkbox"]:checked');
      selectedCount.textContent = checkboxes.length;
      nextBtn2.disabled = checkboxes.length === 0;
      
      selectedGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
    }
    
    // Hàm cập nhật số nhóm nguồn được chọn cho tính năng 3
    function updateSourceGroupsCount() {
      const checkboxes = document.querySelectorAll('#sourceGroupList input[type="checkbox"]:checked');
      selectedSourceCount.textContent = checkboxes.length;
      
      sourceGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
      
      updateNextButton3State();
    }
    
    // Hàm cập nhật số nhóm đích được chọn cho tính năng 3
    function updateTargetGroupsCount() {
      const checkboxes = document.querySelectorAll('#targetGroupList input[type="checkbox"]:checked');
      selectedTargetCount.textContent = checkboxes.length;
      
      targetGroups = Array.from(checkboxes).map(cb => ({
        id: cb.value,
        name: cb.getAttribute('data-name')
      }));
      
      updateNextButton3State();
    }
    
    // Cập nhật trạng thái của nút tiếp tục trong tính năng 3
    function updateNextButton3State() {
      nextBtn3.disabled = sourceGroups.length === 0 || targetGroups.length === 0;
    }
    
    // Hàm hiển thị thông báo thành công với tích xanh
    function showSuccessMessage(message) {
      overlayText.innerHTML = `
        <div class="flex flex-col items-center gap-3">
          <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
          </div>
          <p class="text-green-600 font-medium">${message}</p>
        </div>
      `;
    }

    // Kiểm tra đăng nhập khi load trang
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem('zalo_scanner_logged_in');
      if (isLoggedIn === 'true') {
        showMainApp();
      } else {
        showLoginPage();
      }
    }

    function showLoginPage() {
      toggle(loginPage, true);
      toggle(mainApp, false);
    }

    function showMainApp() {
      toggle(loginPage, false);
      toggle(mainApp, true);
      showPage(homePage);
    }
// Event listeners cho các tính năng
    feature1Card.addEventListener('click', () => {
      showPage(feature1Page);
    });

    feature2Card.addEventListener('click', () => {
      showPage(feature2Page);
      showFeature2Step(step2_1);
    });

    feature3Card.addEventListener('click', () => {
      showPage(feature3Page);
      showFeature3Step(step3_1);
    });

    // Nút Home
    homeBtn.addEventListener('click', () => {
      showPage(homePage);
      toggle(step1, true);
      toggle(step2, false);
      toggle(resultSec, false);
      toggle(actionsBox, false);
      nickSelect.selectedIndex = 0;
      messageTxt.value = '';
      imagesInput.value = '';
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';
      checkImageCount();
      
      showFeature2Step(step2_1);
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      nickSelect2.selectedIndex = 0;
      postContent.value = '';
      postImages.value = '';
      groupList2.innerHTML = '';
      selectedGroups = [];
      enableSchedule.checked = false;
      toggle(scheduleInputs, false);
      updateCharCount();
      checkPostImageCount();
      
      showFeature3Step(step3_1);
      toggle(resultSection3, false);
      toggle(actionsBox3, false);
      sourceGroupList.innerHTML = '';
      targetGroupList.innerHTML = '';
      sourceGroups = [];
      targetGroups = [];
      members = [];
      memberCount.textContent = '0';
      invitedCount.textContent = '0';
      toggle(progressContainer, false);
    });

    // Event listener cho input file
    imagesInput.addEventListener('change', checkImageCount);
    postImages.addEventListener('change', checkPostImageCount);
    
    // Event listener cho textarea
    postContent.addEventListener('input', updateCharCount);
    
    // Event listener cho hẹn giờ
    enableSchedule.addEventListener('change', () => {
      if (enableSchedule.checked) {
        toggle(scheduleInputs, true);
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        scheduleDate.value = tomorrow.toISOString().split('T')[0];
        scheduleTime.value = '09:00';
      } else {
        toggle(scheduleInputs, false);
      }
    });
    
    // Event listener cho select all
    selectAllGroups.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('#groupList2 input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = selectAllGroups.checked);
      updateSelectedGroupsCount();
    });

    // Toggle hiển thị mật khẩu
    togglePassword.addEventListener('click', () => {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      
      if (type === 'text') {
        toggle(eyeOpen, false);
        toggle(eyeClosed, true);
      } else {
        toggle(eyeOpen, true);
        toggle(eyeClosed, false);
      }
    });

    // Xử lý đăng nhập
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = $('username').value.trim();
      const password = $('password').value;

      loginBtn.disabled = true;
      toggle(loginBtnText, false);
      toggle(loginSpinner, true);
      toggle(loginError, false);

      await new Promise(resolve => setTimeout(resolve, 1000));

      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        sessionStorage.setItem('zalo_scanner_logged_in', 'true');
        showMainApp();
        loginForm.reset();
      } else {
        toggle(loginError, true);
        loginForm.classList.add('shake');
        setTimeout(() => loginForm.classList.remove('shake'), 500);
      }

      loginBtn.disabled = false;
      toggle(loginBtnText, true);
      toggle(loginSpinner, false);
    });

    // Đăng xuất
    logoutBtn.addEventListener('click', () => {
      if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
        sessionStorage.removeItem('zalo_scanner_logged_in');
        showLoginPage();
        showPage(homePage);
        toggle(step1, true);
        toggle(step2, false);
        toggle(resultSec, false);
        toggle(actionsBox, false);
        nickSelect.selectedIndex = 0;
        messageTxt.value = '';
        imagesInput.value = '';
        groupList.innerHTML = '';
        groupSelect.innerHTML = '';
        checkImageCount();
      }
    });

    // Ngăn zoom khi double tap trên iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // ---- FEATURE 1: Quét nhóm ----
    scanBtn.addEventListener('click', async () => {
      const nick = nickSelect.value;
      if (!nick) return alert('Vui lòng chọn một nick.');

      scanBtn.disabled = true;
      toggle(spinner, true);
      overlayText.innerHTML = 'Đang quét nhóm, vui lòng chờ...';
      toggle(overlay, true);
      toggle(resultSec, false);
      toggle(actionsBox, false);
      groupList.innerHTML = '';
      groupSelect.innerHTML = '';

      try {
        const res = await fetch(scanWebhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nick }) });
        if (!res.ok) throw new Error('Network error');
        const raw = await res.json();

        let groups = [];
        if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ id: i.groupId || i.groupid || i.id, name: i.name || i.groupName || 'Không tên' }));
        } else if (raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => typeof g === 'string' ? { id: g, name: g } : { id: g.id || g.groupId, name: g.name || g.groupName || g.id });
        }

        if (groups.length === 0) {
          toggle(emptyMsg, true);
        } else {
          toggle(emptyMsg, false);
          groups.forEach(g => {
            groupList.insertAdjacentHTML('beforeend', `<li class="break-words">${g.name}</li>`);
            groupSelect.insertAdjacentHTML('beforeend', `<option value="${g.id}">${g.name}</option>`);
          });
          toggle(actionsBox, true);
        }
        toggle(resultSec, true);
      } catch ( err) {
        console.error(err);
        alert('Quét nhóm thất bại, vui lòng thử lại.');
      } finally {
        scanBtn.disabled = false;
        toggle(spinner, false);
        toggle(overlay, false);
      }
    });

    // ---- FEATURE 1: Chuyển sang bước 2 ----
    nextBtn.addEventListener('click', () => {
      const groupId = groupSelect.value;
      if (!groupId) return alert('Vui lòng chọn một nhóm.');
      currentGroup = { id: groupId, name: groupSelect.options[groupSelect.selectedIndex].text };
      chosenGroup.textContent = `Sẽ gửi đến: ${currentGroup.name}`;
      toggle(step1, false);
      toggle(step2, true);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ---- FEATURE 1: Quay lại ----
    backBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggle(step2, false);
      toggle(step1, true);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ---- FEATURE 1: Gửi tin nhắn ----
    sendMsgBtn.addEventListener('click', async () => {
      const nick = nickSelect.value;
      const text = messageTxt.value.trim();
      const files = imagesInput.files;
      if (!text) return alert('Vui lòng nhập nội dung.');
      if (files.length > 3) return alert('Chỉ tải tối đa 3 ảnh.');

      sendMsgBtn.disabled = true;
      toggle(spinnerSend, true);
      overlayText.innerHTML = 'Đang tiến hành gửi tin nhắn, vui lòng chờ...';
      toggle(overlay, true);

      try {
        const formData = new FormData();
        formData.append('nick', nick);
        formData.append('groupId', currentGroup.id);
        formData.append('groupName', currentGroup.name);
        formData.append('text', text);
        Array.from(files).forEach((f, idx) => formData.append('image' + (idx + 1), f));

        const res = await fetch(sendWebhook, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Send error');
        await res.json();

        showSuccessMessage('Đã gửi tin nhắn thành công!');
        messageTxt.value = '';
        imagesInput.value = '';
        checkImageCount();

        setTimeout(() => {
          toggle(overlay, false);
          toggle(step2, false);
          toggle(step1, true);
          overlayText.innerHTML = 'Đang xử lý...';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 3000);
      } catch (err) {
        console.error(err);
        alert('Gửi tin nhắn thất bại, vui lòng thử lại.');
        toggle(overlay, false);
      } finally {
        sendMsgBtn.disabled = false;
        toggle(spinnerSend, false);
      }
    });
// ---- FEATURE 2: Quét nhóm cho đăng bài ----
    scanBtn2.addEventListener('click', async () => {
      const nick = nickSelect2.value;
      if (!nick) return alert('Vui lòng chọn một nick.');

      scanBtn2.disabled = true;
      toggle(spinner2, true);
      overlayText.innerHTML = 'Đang quét nhóm, vui lòng chờ...';
      toggle(overlay, true);
      toggle(resultSection2, false);
      toggle(actionsBox2, false);
      groupList2.innerHTML = '';
      selectedGroups = [];

      try {
        const res = await fetch(scanWebhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nick }) });
        if (!res.ok) throw new Error('Network error');
        const raw = await res.json();

        let groups = [];
        if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ id: i.groupId || i.groupid || i.id, name: i.name || i.groupName || 'Không tên' }));
        } else if (raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => typeof g === 'string' ? { id: g, name: g } : { id: g.id || g.groupId, name: g.name || g.groupName || g.id });
        }

        if (groups.length === 0) {
          toggle(emptyMsg2, true);
        } else {
          toggle(emptyMsg2, false);
          groups.forEach((g, index) => {
            groupList2.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateSelectedGroupsCount()"
                >
                <label for="group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
          toggle(actionsBox2, true);
        }
        toggle(resultSection2, true);
        updateSelectedGroupsCount();
      } catch (err) {
        console.error(err);
        alert('Quét nhóm thất bại, vui lòng thử lại.');
      } finally {
        scanBtn2.disabled = false;
        toggle(spinner2, false);
        toggle(overlay, false);
      }
    });

    // ---- FEATURE 2: Chuyển sang soạn nội dung ----
    nextBtn2.addEventListener('click', () => {
      if (selectedGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm.');
      
      const groupNames = selectedGroups.map(g => g.name).join(', ');
      selectedGroupsDisplay.textContent = `Sẽ đăng bài vào ${selectedGroups.length} nhóm: ${groupNames}`;
      showFeature2Step(step2_2);
    });

    // ---- FEATURE 2: Quay lại ----
    backBtn2.addEventListener('click', () => {
      showFeature2Step(step2_1);
    });

    // ---- FEATURE 2: Đăng bài ----
    publishBtn.addEventListener('click', async () => {
      const nick = nickSelect2.value;
      const text = postContent.value.trim();
      const files = postImages.files;
      
      if (!text) return alert('Vui lòng nhập nội dung bài viết.');
      if (files.length !== 4) return alert('Vui lòng tải đúng 4 ảnh.');
      if (selectedGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm.');

      let scheduleData = null;
      if (enableSchedule.checked) {
        if (!scheduleDate.value || !scheduleTime.value) {
          return alert('Vui lòng chọn ngày và giờ hẹn đăng bài.');
        }
        scheduleData = {
          date: scheduleDate.value,
          time: scheduleTime.value
        };
      }

      publishBtn.disabled = true;
      toggle(publishSpinner, true);
      overlayText.innerHTML = 'Đang tiến hành đăng bài, vui lòng chờ...';
      toggle(overlay, true);

      try {
        const formData = new FormData();
        formData.append('nick', nick);
        formData.append('text', text);
        formData.append('groups', JSON.stringify(selectedGroups));
        
        Array.from(files).forEach((f, idx) => {
          formData.append('image' + (idx + 1), f);
        });
        
        if (scheduleData) {
          formData.append('schedule', JSON.stringify(scheduleData));
        }

        const res = await fetch('https://primary-production-55bc0.up.railway.app/webhook/zalo-post-group', { 
          method: 'POST', 
          body: formData 
        });
        
        if (!res.ok) throw new Error('Post error');
        await res.json();

        showSuccessMessage('Đã đăng bài thành công!');
        
        postContent.value = '';
        postImages.value = '';
        enableSchedule.checked = false;
        toggle(scheduleInputs, false);
        updateCharCount();
        checkPostImageCount();

        setTimeout(() => {
          toggle(overlay, false);
          showFeature2Step(step2_1);
          overlayText.innerHTML = 'Đang xử lý...';
        }, 3000);
      } catch (err) {
        console.error(err);
        alert('Đăng bài thất bại, vui lòng thử lại.');
        toggle(overlay, false);
      } finally {
        publishBtn.disabled = false;
        toggle(publishSpinner, false);
      }
    });

    // ---- FEATURE 3: Quét nhóm cho mời thành viên ----
    scanBtn3.addEventListener('click', async () => {
      const nick = nickSelect3.value;
      if (!nick) return alert('Vui lòng chọn một nick.');

      scanBtn3.disabled = true;
      toggle(spinner3, true);
      overlayText.innerHTML = 'Đang quét nhóm, vui lòng chờ...';
      toggle(overlay, true);
      toggle(resultSection3, false);
      toggle(actionsBox3, false);
      sourceGroupList.innerHTML = '';
      targetGroupList.innerHTML = '';
      toggle(emptySourceMsg, false);
      toggle(emptyTargetMsg, false);
      sourceGroups = [];
      targetGroups = [];

      try {
        const res = await fetch(scanWebhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nick }) });
        if (!res.ok) throw new Error('Network error');
        const raw = await res.json();

        let groups = [];
        if (Array.isArray(raw)) {
          groups = raw.filter(i => i.groupId || i.groupid || i.id).map(i => ({ id: i.groupId || i.groupid || i.id, name: i.name || i.groupName || 'Không tên' }));
        } else if (raw.groups) {
          groups = raw.groups.filter(g => typeof g === 'string' || g.id || g.groupId).map(g => typeof g === 'string' ? { id: g, name: g } : { id: g.id || g.groupId, name: g.name || g.groupName || g.id });
        }

        if (groups.length === 0) {
          toggle(emptySourceMsg, true);
          toggle(emptyTargetMsg, true);
        } else {
          // Thêm các nhóm vào danh sách nguồn
          groups.forEach((g, index) => {
            sourceGroupList.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="source_group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                  onchange="updateSourceGroupsCount()"
                >
                <label for="source_group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
            
            // Thêm các nhóm vào danh sách đích
            targetGroupList.insertAdjacentHTML('beforeend', `
              <div class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50">
                <input 
                  type="checkbox" 
                  id="target_group_${index}" 
                  value="${g.id}" 
                  data-name="${g.name}"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                  onchange="updateTargetGroupsCount()"
                >
                <label for="target_group_${index}" class="text-sm text-gray-700 break-words flex-1 cursor-pointer">${g.name}</label>
              </div>
            `);
          });
        }
        
        toggle(resultSection3, true);
        toggle(actionsBox3, true);
        updateSourceGroupsCount();
        updateTargetGroupsCount();
      } catch (err) {
        console.error(err);
        alert('Quét nhóm thất bại, vui lòng thử lại.');
      } finally {
        scanBtn3.disabled = false;
        toggle(spinner3, false);
        toggle(overlay, false);
      }
    });
    
    // ---- FEATURE 3: Chuyển sang bước 2 ----
    nextBtn3.addEventListener('click', () => {
      if (sourceGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm nguồn.');
      if (targetGroups.length === 0) return alert('Vui lòng chọn ít nhất một nhóm đích.');
      
      // Hiển thị thông tin nhóm nguồn và đích
      const sourceNames = sourceGroups.map(g => g.name).join(', ');
      const targetNames = targetGroups.map(g => g.name).join(', ');
      
      sourceGroupDisplay.textContent = `Nhóm nguồn: ${sourceNames}`;
      targetGroupDisplay.textContent = `Nhóm đích: ${targetNames}`;
      
      showFeature3Step(step3_2);
      members = [];
      memberCount.textContent = '0';
      invitedCount.textContent = '0';
      toggle(progressContainer, false);
      inviteBtn.disabled = true;
    });
    
    // ---- FEATURE 3: Quay lại bước 1 ----
    backBtn3.addEventListener('click', () => {
      showFeature3Step(step3_1);
    });
    
    // ---- FEATURE 3: Quét thành viên ----
    scanMembersBtn.addEventListener('click', async () => {
      const nick = nickSelect3.value;
      
      scanMembersBtn.disabled = true;
      toggle(scanMembersSpinner, true);
      overlayText.innerHTML = 'Đang quét thành viên trong nhóm, vui lòng chờ...';
      toggle(overlay, true);
      
      try {
        members = [];
        let totalMembers = 0;
        
        // Quét thành viên từ các nhóm nguồn
        for (const group of sourceGroups) {
          overlayText.innerHTML = `Đang quét thành viên từ nhóm: ${group.name}...`;
          
          const res = await fetch('https://primary-production-55bc0.up.railway.app/webhook/zalo-scan-members', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nick, groupId: group.id })
          });
          
          if (!res.ok) throw new Error(`Lỗi khi quét nhóm ${group.name}`);
          
          const data = await res.json();
          if (data.members && Array.isArray(data.members)) {
            // Lọc thành viên chưa có trong danh sách
            const newMembers = data.members.filter(m => 
              !members.some(existing => existing.id === m.id)
            );
            
            members = [...members, ...newMembers];
            totalMembers += newMembers.length;
            memberCount.textContent = totalMembers;
          }
        }
        
        showSuccessMessage(`Đã quét được ${totalMembers} thành viên!`);
        inviteBtn.disabled = false;
        
        // Nếu đã chọn tự động mời, tiến hành mời luôn
        if (autoInvite.checked && members.length > 0) {
          setTimeout(() => {
            inviteBtn.click();
          }, 1000);
        }
      } catch (err) {
        console.error(err);
        alert('Quét thành viên thất bại: ' + err.message);
      } finally {
        scanMembersBtn.disabled = false;
        toggle(scanMembersSpinner, false);
        toggle(overlay, false);
      }
    });
    
    // ---- FEATURE 3: Mời thành viên ----
    inviteBtn.addEventListener('click', async () => {
      if (members.length === 0) return alert('Chưa có thành viên nào được quét. Vui lòng quét thành viên trước.');
      
      const maxToInvite = parseInt(maxInvites.value) || 30;
      if (maxToInvite <= 0) return alert('Số lượng mời không hợp lệ.');
      
      const membersToInvite = members.slice(0, maxToInvite);
      const nick = nickSelect3.value;
      
      inviteBtn.disabled = true;
      toggle(inviteSpinner, true);
      toggle(progressContainer, true);
      
      let invitedSuccess = 0;
      progressBar.style.width = '0%';
      progressText.textContent = '0%';
      
      for (let i = 0; i < targetGroups.length; i++) {
        const targetGroup = targetGroups[i];
        overlayText.innerHTML = `Đang mời thành viên vào nhóm: ${targetGroup.name}...`;
        toggle(overlay, true);
        
        try {
          for (let j = 0; j < membersToInvite.length; j++) {
            const member = membersToInvite[j];
            const progress = Math.round(((i * membersToInvite.length + j + 1) / (targetGroups.length * membersToInvite.length)) * 100);
            
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            
            try {
              const res = await fetch(inviteWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  nick,
                  groupId: targetGroup.id,
                  memberId: member.id,
                  memberName: member.name || 'Không tên'
                })
              });
              
              if (res.ok) {
                invitedSuccess++;
                invitedCount.textContent = invitedSuccess;
              }
              
              // Thêm delay để tránh bị khóa tài khoản
              await new Promise(resolve => setTimeout(resolve, 500));
            } catch (memberErr) {
              console.error(`Lỗi khi mời thành viên ${member.name || member.id}:`, memberErr);
              // Tiếp tục với thành viên tiếp theo
            }
          }
        } catch (groupErr) {
          console.error(`Lỗi khi mời thành viên vào nhóm ${targetGroup.name}:`, groupErr);
          alert(`Có lỗi xảy ra khi mời thành viên vào nhóm ${targetGroup.name}. Tiếp tục với nhóm tiếp theo.`);
        }
      }
      
      progressBar.style.width = '100%';
      progressText.textContent = '100%';
      
      showSuccessMessage(`Đã mời thành công ${invitedSuccess} thành viên!`);
      
      setTimeout(() => {
        toggle(overlay, false);
      }, 2000);
      
      inviteBtn.disabled = false;
      toggle(inviteSpinner, false);
    });

    // Khởi tạo ứng dụng
    checkAuth();
    
    // Đảm bảo các hàm cập nhật có thể truy cập global
    window.updateSelectedGroupsCount = updateSelectedGroupsCount;
    window.updateSourceGroupsCount = updateSourceGroupsCount;
    window.updateTargetGroupsCount = updateTargetGroupsCount;
    
    // Khởi tạo các giá trị ban đầu
    updateCharCount();
    checkImageCount();
    checkPostImageCount();
  </script>
</body>
</html>
